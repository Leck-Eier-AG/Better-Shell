---
phase: 02-audio
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/audio.sh
  - lib/audio-player.sh
  - tests/test_audio.sh
  - better-shell.sh
autonomous: true
requirements: [AUD-01, AUD-02]
gap_closure: true

must_haves:
  truths:
    - "Error sound plays on failed command regardless of duration (e.g., `false` triggers error audio)"
    - "Threshold still suppresses trivial success commands (e.g., `echo hi` plays nothing)"
    - "Background audio playback produces zero visible output in the terminal (no [N] done messages)"
    - "Sound pack switching works for error sounds in all packs (chill, retro, meme)"
  artifacts:
    - path: "lib/audio.sh"
      provides: "Reordered decision flow: error events bypass threshold"
      contains: "_BSH_LAST_EXIT.*-ne 0"
    - path: "lib/audio-player.sh"
      provides: "Parent-scoped set +m before backgrounding"
      contains: "set +m"
    - path: "tests/test_audio.sh"
      provides: "Tests for error-bypasses-threshold and job-control-silence"
    - path: "better-shell.sh"
      provides: "Rebuilt distributable with both fixes"
  key_links:
    - from: "lib/audio.sh"
      to: "_bsh_play_sound"
      via: "error event determination BEFORE threshold gate"
      pattern: "_BSH_LAST_EXIT.*-ne 0.*before.*threshold"
    - from: "lib/audio-player.sh"
      to: "parent shell"
      via: "set +m in parent context before ( ... ) &"
      pattern: "set \\+m.*\\( .* \\) &"
---

<objective>
Close 3 UAT gaps from Phase 02 user testing. Two gaps share the same root cause (error sounds never play because the duration threshold fires before event-type determination). The third gap is job control messages leaking to the terminal from background audio playback.

Purpose: Make error sounds work for fast-failing commands and eliminate terminal noise from background playback.
Output: Fixed lib/audio.sh, fixed lib/audio-player.sh, updated tests, rebuilt better-shell.sh
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-audio/02-UAT.md
@.planning/debug/error-sound-never-plays.md
@.planning/debug/job-control-leak.md

<interfaces>
<!-- Key functions and flow the executor needs to understand -->

From lib/audio.sh (_bsh_audio_trigger, lines 168-207):
```sh
# Current BROKEN flow (threshold before event type):
#   1. No player -> return
#   2. Whitelist match -> skip threshold & blacklist
#   3. Duration below threshold -> return   <-- BLOCKS ERRORS
#   4. Blacklist match -> return
#   5. Determine event type (error/warning/success)  <-- NEVER REACHED for fast errors
#   6. Resolve intensity + sound file -> play
```

From lib/audio-player.sh (_bsh_play_sound, lines 82-111):
```sh
# Current BROKEN pattern:
  (
    set +m          # <-- WRONG: affects child, not parent
    case "$_BSH_AUDIO_TOOL" in
      pw-play) pw-play --volume="..." "$file" >/dev/null 2>&1 ;;
      # ...
    esac
  ) &
  disown $! 2>/dev/null
```

From tests/test_audio.sh (Test 17, lines 223-236):
```sh
# Test 17 currently EXPECTS threshold to block errors (exit=1, duration=0)
# This test validates the BUGGY behavior and must be updated
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix error events bypassing threshold and update tests</name>
  <files>lib/audio.sh, tests/test_audio.sh</files>
  <action>
In lib/audio.sh, reorder _bsh_audio_trigger so error events (non-zero exit code) bypass the duration threshold. The new decision flow must be:

1. Hot reload config (unchanged)
2. Guard: no audio player -> return (unchanged)
3. Extract cmd_name (unchanged)
4. Determine event type FIRST:
   - if _BSH_LAST_EXIT != 0 -> event="error"
   - elif _BSH_LAST_STDERR non-empty -> event="warning"
   - else -> event="success"
5. For error events: skip threshold check entirely, still check blacklist
6. For non-error events: apply whitelist/threshold/blacklist as before
   - Whitelist overrides threshold and blacklist
   - Threshold blocks short success/warning commands
   - Blacklist blocks interactive commands
7. Resolve intensity and sound file -> play (unchanged)

The key change: move lines 188-195 (event determination) to BEFORE lines 179-185 (whitelist/threshold/blacklist). Then wrap the threshold check in a condition: only apply threshold when event != "error".

Keep blacklist check for ALL events (including errors) -- user probably does not want error sounds from vim/python/etc.

In tests/test_audio.sh, update Test 17 which currently expects threshold to block error commands. Change it to:

- Test 17: "error event bypasses threshold (duration=0, exit=1, non-blacklisted cmd)" -- set _BSH_CMD_DURATION=0, _BSH_LAST_EXIT=1, _BSH_LAST_CMD="make build", expect PLAY_CALLED=1 and PLAY_FILE contains "error"

Add a new Test 29: "threshold still blocks short success commands (duration=0, exit=0)" -- set _BSH_CMD_DURATION=0, _BSH_LAST_EXIT=0, _BSH_LAST_CMD="ls", expect PLAY_CALLED=0

Add a new Test 30: "error event still blocked by blacklist (vim with exit=1)" -- set _BSH_CMD_DURATION=0, _BSH_LAST_EXIT=1, _BSH_LAST_CMD="vim foo.txt", _BSH_AUDIO_TOOL="test", expect PLAY_CALLED=0

Point _BSH_DIR to the project root for test 17 so _bsh_resolve_sound can find bundled error sounds. Use the same pattern as existing test 28 (_BSH_PROJECT_ROOT).

Update the TAP plan line at the top if one exists, or the count reference to reflect the new total.
  </action>
  <verify>
    <automated>cd /home/maxi/Documents/coding/Projects/Better-Shell && bash tests/test_audio.sh</automated>
  </verify>
  <done>All tests pass including: (1) error event bypasses threshold for fast-failing commands, (2) threshold still blocks trivial successes, (3) blacklist still blocks error sounds from interactive commands like vim</done>
</task>

<task type="auto">
  <name>Task 2: Fix job control message leak and rebuild distributable</name>
  <files>lib/audio-player.sh, better-shell.sh</files>
  <action>
In lib/audio-player.sh, fix _bsh_play_sound to suppress ALL job control output by disabling monitor mode in the PARENT shell before backgrounding the subshell.

Replace the current pattern (lines 91-108):
```sh
  (
    set +m
    case "$_BSH_AUDIO_TOOL" in
      ...
    esac
  ) &
  disown $! 2>/dev/null
```

With the corrected pattern:
```sh
  # Disable job control in the parent to prevent [N] done messages
  set +m 2>/dev/null
  (
    case "$_BSH_AUDIO_TOOL" in
      ...
    esac
  ) &
  disown $! 2>/dev/null
  # Re-enable job control for the interactive shell
  set -m 2>/dev/null
```

The `2>/dev/null` on set +m/-m suppresses "no job control" warnings if called in a non-interactive context (e.g., tests, scripts).

Do NOT add any tests for the job control fix -- it can only be verified interactively in a real terminal (the test harness is non-interactive and has no monitor mode). The UAT re-test will validate this.

After both fixes are in place, run `make build` to rebuild better-shell.sh with the patched lib files. Then run `make test` to confirm all tests still pass against the rebuilt distributable.
  </action>
  <verify>
    <automated>cd /home/maxi/Documents/coding/Projects/Better-Shell && make build && make test</automated>
  </verify>
  <done>better-shell.sh rebuilt with both fixes. All tests pass. Job control fix in place (set +m in parent before backgrounding, set -m after disown).</done>
</task>

</tasks>

<verification>
1. `bash tests/test_audio.sh` -- all 30 tests pass (28 original + 2 new, with test 17 updated)
2. `make build && make test` -- distributable builds and all test suites pass
3. Manual verification (UAT re-test): source better-shell.sh in a terminal, run `false` -- error sound plays. Run `echo hi` -- no sound. No `[N] done` messages appear after any sound playback.
</verification>

<success_criteria>
- Error sounds play for fast-failing commands (`false`, typos, `ls /nonexistent`)
- Trivial success commands (under threshold) remain silent
- Background audio produces zero terminal output (no job control messages)
- All 30 automated tests pass
- better-shell.sh distributable rebuilt with both fixes
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio/02-03-SUMMARY.md`
</output>
